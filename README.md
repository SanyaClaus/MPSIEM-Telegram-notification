# MPSIEM-Telegram-notification

Отправка инцидентов из MaxPatrol SIEM 10 в Telegram бот.

Бот с определенной периодичностью проверяет наличие новых инцидентов в MaxPatrol SIEM.
Если обнаружен новый инцидент, информация о нем отправляется во все чаты, в которые администратор разрешил отправку оповещений.
Инциденты со статусом "Новый" могут быть подтверждены или закрыты по нажатию соответствующей кнопки в боте.


Написано для версии 26.0.4827, обновлено на версии 26.1.7351.
<details> 
  <summary>Скриншоты</summary>
  <img src="https://github.com/SanyaClaus/MPSIEM-Telegram-notification/blob/experimental20240307/Preview1.png">
  <img src="https://github.com/SanyaClaus/MPSIEM-Telegram-notification/blob/experimental20240307/Preview2.png">
</details>



## Отказ от ответственности 

Рекомендуеся тщательно проверить код перед использованием его в производственной среде и провести оценку его безопасности.
Автор не несет ответственности за любой ущерб или убытки, возникшие в результате использования этого кода или его фрагментов. Используйте его на свой страх и риск.

## Настройки

В файле ```settings.py``` находятся настройки бота:

- dbFileName - путь к файлу, в котором будут сохранятся данные бота (временные метки последних инцидентов, событий в ТГ, разрешенные чаты)
- pause_time - время в секундах между проверками инцидентов
- time_zone - часовой пояс (в SIEM события хранятся с временем по GMT+0, соответсвенно для отображения времени по Москве нужно задать +3 часа)
- username - имя пользоватея в SIEM
- password - пароль пользователя в SIEM
- client_id - идентификатор приложения (mpx, ptkb)
- client_secret - ключ доступа к приложению в SIEM
- base_url - url для входа в SIEM
- tg_bot_token - токен Телеграм-бота
- tg_updates_timeout - время ожидания новых событий в Телеграм
- admin_chat_id - id чата с администратором в Телеграм
- max_events_count - максимальное количество событий, которое будет отображено в оповещении об инциденте
- default_header - заголовок запросов, с которыми будет обращаться бот к SIEM
- ping_sticker - ссылка на GIF-анимацию или file_id, которую пришлет бот в ответ на команду /ping в Telegram


client_secret для авторизации скрипта в SIEM можно взять в конфигурации Core (*/var/lib/deployed-roles/mp10-application/core-##########/install.sh*)

tg_bot_token для работы бота можно получить у https://t.me/BotFather

Для получения chat_id можно написать своему боту любое сообщение, затем перейти по ссылке вида *https://api.telegram.org/bot123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11/getUpdates*, где *123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11* это токен вашего бота Телеграм, там вы найдете chat/id.

## Запуск

Запуск скрипта возможен как на удаленной машине, так и на машине с SIEM. Скрипт одинаково работает как на Windows, так и на Unix-подобной системе. Работоспособность проверена на Python 3.7, Python 3.10, Python 3.11.

Для запуска по SSH рекомендую использовать следующую команду: 
```nohup python3 mp-siem-tg-bot-notification.py &```

При первом запуске файл БД будет создан автоматически по пути, указанному в параметре dbFileName в файле ```settings.py```.

После создания файла БД таблица tg_users_allowed не содержит записей (т.е. оповещения об инцидентах не будут отправлять никому). Когда какой-либо пользователь нажмет кнопку "Старт" в боте или отправит команду ```/start```, администратор получит сообщение вида:
>Обнаружен новый пользователь @nickname (id 0123456789).<br>
Разрешить отправку оповещений об инцидентах в это чат?<br>
```Разрешить``` ```Проигнорировать``` ```Заблокировать```

- ```Разрешить``` - добавить пользователя в список рассылки новых инцидентов.
- ```Проигнорировать``` - не добавлять пользователя в список рассылки новых инцидентов, но и не блокировать его. Если пользователь повторно отправит комнаду ```/start```, администратор снова получит оповещение о новом пользователе бота.
- ```Заблокировать``` - добавить пользователя в список заблокированных, не обрабатывать его сообщения и команды, не получать оповещения о его действиях с ботом.

Если администратор не нажал ни одну из кнопок, пользователь не будет включен в список рассылки новых инцидентов (аналогично кнопке Проигнорировать).

Отправив команду ```/deny123456789``` (где 123456789 это id пользователя Телеграм) администратор исключает пользователя из списка рассылки новых инцидентов (команда применима в любой момент).

Для включения администратора в список рассылки новых инцидентов он тоже должен включить себя в него командой ```/accept123456789```.

Для ускорения этого процесса администратор может просто отправить повторно команду ```/start```, после чего он получит описанное ранее сообщение с возможностью добавить себя в список рассылки.

## Работа бота

Бот авторизуется в SIEM и получает токен, с которым осуществляет все дальнейшие обращения к SIEM по API.

Если токен закончится (обычно через 24 часа) и будет получена ошибка 401 (Unauthorised), будет выполнен новый запрос на получение токена.

Если в SIEM появляются новые инциденты, информация о них отправляется пользователям бота. Для исключения неавторизованного доступа к боту, после запуска бот отправляет оповещения только разрешенным администратором пользователям.

Администратором является пользователь, указанный в параметре admin_chat_id в файле ```settings.py```.

Если новый пользователь начинает работу с ботом (команда ```/start```), то администратору бота приходит оповещение о новом пользователе и выбором - разрешить или запретить ему получение оповещений об инцидентах.

В случае добавления бота в чат, администратор так же получит оповещение с выбором, отправлять ли оповещения в новый чат.

Когда бот обнаружает в MaxPatrol SIEM новый инцидент, он отправляет сообщение с информацией об инциденте во все разрешенные администратором чаты. Сообщение содержит основную информацию по инциденту (ID, время, опасность, тип, имя, статус), ссылку на инцидент (для быстрого перехода в инцидент в системе MaxPatrol SIEM), а также события по этому инциденту (их выводимое количество можно изменить в параметре max_events_count в файле ```settings.py```), а также кнопки взаимодействия с инцидентом:
- ```Обновить``` - обновить информацию об инциденте (бывает полезно, если в инциденте появились новые события или изменился его статус).
- ```Подтвердить``` - запустить инцидент в работу, но не назначать ответственного за него (доступна только у инцидентов со статусом "New").
- ```Закрыть``` - закрыть инцидент как ложный, в комментарии указать, какой пользователь закрыл инцидент (доступна только у инцидентов со статусом "New").

Внимание! Взаимодействовать с кнопками может каждый пользователь чата, в который осуществляется отправка оповещений!


### Команды, доступные администратору:

```/accepted``` - вывести список чатов, куда отправляются оповещения об инцидентах.

```/accept[chat_id]``` - добавить чат с идентификатором [chat_id] в список чатов, куда отправляются оповещения об инцидентах.
Для добавления чата с пользователем команда будет выглядеть как ```/accept0123456789```, для добавления группового чата ```/accept-0123456789```

```/deny[chat_id]``` - исключить чат с идентификатором [chat_id] из списка чатов, куда отправляются оповещения об инцидентах.
Для удаления чата с пользователем команда будет выглядеть как ```/deny0123456789```, для удаления группового чата ```/deny-0123456789```

```/ban[chat_id]``` - заблокировать чат идентификатором [chat_id]. Бот не будет реагировать на команды из этого чата, администратор перестанет получать оповещения при отправке им команды /start указанным пользователем, или при добавлении бота в указанный групповой чат.

```/unban[chat_id]``` - разблокировать чат идентификатором [chat_id].

```/banned``` - вывести список заблокированных чатов.

```/debug``` - вывести последние строки лога.

```/ping``` - проверить доступность бота.

```/help``` - вывести справку по командам.

### Команды, доступные разрешеннмы пользователям:

```/ping``` - проверить доступность бота.
